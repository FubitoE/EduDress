{% load static %}

<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/customize.css' %}">
    <title>アバターの着せ替え</title>
</head>

<body>
    <!-- アバタープレビュー -->
    <div class="avatar-preview">
        <h2>プレビュー</h2>
        <canvas id="avatar-canvas" width="400" height="400"></canvas>
    </div>

    <div class="customize-container">
        <h1>アバターの着せ替え</h1>

        <!-- カテゴリ別のパーツ選択 -->
        {% for category, category_name in PARTS_CATEGORY %}
        <div class="category-container">
            <h2>{{ category_name }}</h2>
            <div class="parts-list">
                {% for part in parts %}
                    {% if part.parts_category == category %}
                    <div class="part-item">
                        <input 
                            type="radio" 
                            id="part_{{ part.parts_id }}" 
                            name="{{ category }}" 
                            value="{{ part.parts_image.url }}">
                        <label for="part_{{ part.parts_id }}">
                            <img src="{{ part.parts_image.url }}" alt="{{ part.parts_name }}" class="part-image">
                            <p>{{ part.parts_name }}</p>
                        </label>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <!-- 保存ボタン -->
        <button id="save-avatar" class="save-button">保存</button>
    </div>
</body>


    <script>
        const canvas = document.getElementById('avatar-canvas');
        const ctx = canvas.getContext('2d');
        const selectedParts = {};

        // パーツの選択を監視
        document.querySelectorAll('input[type="radio"]').forEach(input => {
            input.addEventListener('change', event => {
                const category = input.name;
                selectedParts[category] = input.value; // 選択した画像URLを保存
                renderAvatar();
            });
        });

        // Canvasにアバターを描画
        function renderAvatar() {
            const layers = Object.values(selectedParts); // 選択されたすべての画像URL
            ctx.clearRect(0, 0, canvas.width, canvas.height); // 画面をクリア

            layers.forEach((url) => {
                const img = new Image();
                img.src = url;
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height); // レイヤーを順番に描画
                };
            });
        }

        // 保存リクエスト（Canvas画像を送信）
        document.getElementById('save-avatar').addEventListener('click', () => {
            const image = canvas.toDataURL('image/png'); // Canvasを画像データに変換

            fetch('/api/save-avatar/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ image })
            })
            .then(response => response.json())
            .then(data => alert(data.message))
            .catch(error => alert('保存中にエラーが発生しました。'));
        });
    </script>
</body>
</html>
