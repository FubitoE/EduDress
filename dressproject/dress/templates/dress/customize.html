{% load static %}
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <title>ã‚¢ãƒã‚¿ãƒ¼ã®ç€ã›æ›¿ãˆ</title>
    <link rel="stylesheet" href="{% static 'css/customize.css' %}">
</head>

<body>
    <!-- ã‚¢ãƒã‚¿ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div class="avatar-preview">
        <canvas id="avatar-canvas" width="400" height="400"></canvas>
    </div>

    <div class="customize-container">

        <!-- ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ– -->
        <ul class="nav nav-tabs" id="avatar-tabs" role="tablist">
            {% for category, category_name in PARTS_CATEGORY %}
            <li class="nav-item">
                <a class="nav-link" id="tab-{{ category }}" data-toggle="tab" href="#{{ category }}" role="tab" aria-controls="{{ category }}" aria-selected="false">{{ category_name }}</a>
            </li>
            {% endfor %}
        </ul>

        <!-- ã‚¿ãƒ–ã®å†…å®¹ -->
        <div class="tab-content" id="avatar-tabs-content">
            {% for category, category_name in PARTS_CATEGORY %}
            <div class="tab-pane fade" id="{{ category }}" role="tabpanel" aria-labelledby="tab-{{ category }}">
                <div class="parts-list">
                    {% for part in parts %}
                        {% if part.parts_category == category %}
                        <div class="part-item">
                            {% if user_rank >= part.unlock_rank %}
                                <!-- ä½¿ç”¨å¯èƒ½ãªãƒ‘ãƒ¼ãƒ„ -->
                                <input 
                                    type="radio" 
                                    id="part_{{ part.parts_id }}" 
                                    name="{{ category }}" 
                                    value="{{ part.parts_image.url }}" 
                                    {% if part.parts_default %}checked{% endif %}>
                                <label for="part_{{ part.parts_id }}">
                                    <img src="{{ part.parts_image.url }}" alt="{{ part.parts_name }}" class="part-image">
                                </label>
                            {% else %}
                                <!-- ä½¿ç”¨ä¸å¯ã®ãƒ‘ãƒ¼ãƒ„ -->
                                <div class="locked-part">
                                    <img src="{{ part.parts_image.url }}" alt="{{ part.parts_name }}" class="part-image locked">
                                    <div class="lock-overlay">
                                        <span class="lock-icon">ğŸ”’</span>
                                        <span>ãƒ©ãƒ³ã‚¯{{ part.unlock_rank }}ã§è§£æ”¾</span>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
        <div class="button-container">
            <button id="go-home" class="home-button btn btn-secondary">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
            <button id="save-avatar" class="save-button">ä¿å­˜</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('avatar-canvas');
    const ctx = canvas.getContext('2d');
    const selectedParts = {};

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ¼ãƒ„ã‚’è¨­å®š
    document.querySelectorAll('input[type="radio"][checked]').forEach(input => {
        selectedParts[input.name] = input.value;
    });

    // ãƒ‘ãƒ¼ãƒ„ã®é¸æŠã‚’ç›£è¦–
    document.querySelectorAll('input[type="radio"]').forEach(input => {
        input.addEventListener('change', event => {
            const category = input.name;
            selectedParts[category] = input.value; // é¸æŠã—ãŸç”»åƒURLã‚’ä¿å­˜
            renderAvatar();
        });
    });

    // ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åº
    const layerOrder = ['base', 'eyes', 'clothes', 'accessory', 'hair'];

    // Canvasã«ã‚¢ãƒã‚¿ãƒ¼ã‚’æç”»
    function renderAvatar() {
        ctx.clearRect(0, 0, canvas.width, canvas.height); // ç”»é¢ã‚’ã‚¯ãƒªã‚¢

        layerOrder.forEach(category => {
            const url = selectedParts[category];
            if (url) {
                const img = new Image();
                img.src = url;
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height); // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é †ç•ªã«æç”»
                };
            }
        });
    }

    // åˆæœŸæç”»
    renderAvatar();

    // ä¿å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆCanvasç”»åƒã‚’é€ä¿¡ï¼‰
    document.getElementById('save-avatar').addEventListener('click', () => {
        const image = canvas.toDataURL('image/png'); // Canvasã‚’ç”»åƒãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
        const selectedPartsList = [];

        // é¸æŠã•ã‚ŒãŸãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’å–å¾—
        document.querySelectorAll('input[type="radio"]:checked').forEach(input => {
            selectedPartsList.push(input.id.replace('part_', '')); // IDã‹ã‚‰ãƒ‘ãƒ¼ãƒ„IDã‚’æŠ½å‡º
        });

        if (selectedPartsList.length === 0) {
            alert('é¸æŠã•ã‚ŒãŸãƒ‘ãƒ¼ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }

        fetch('/api/save-avatar/', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'X-CSRFToken': '{{ csrf_token }}' 
            },
            body: JSON.stringify({
                image,
                selected_parts: selectedPartsList, // ãƒ‘ãƒ¼ãƒ„IDãƒªã‚¹ãƒˆã‚’é€ä¿¡
            })
        })
        .then(response => response.json())
        .then(data => alert(data.message))
        .catch(error => alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'));
    });

    // ã€Œãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã®å‹•ä½œ
    document.getElementById('go-home').addEventListener('click', () => {
        window.location.href = '/home/'; // ãƒ›ãƒ¼ãƒ ã«é·ç§»
    });

    // ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãƒ‘ãƒ¼ãƒ„ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.locked-part').forEach(part => {
        part.addEventListener('click', () => {
            alert('ã“ã®ãƒ‘ãƒ¼ãƒ„ã¯æœªè§£æ”¾ã§ã™ã€‚å¿…è¦ãƒ©ãƒ³ã‚¯ã‚’æº€ãŸã™ã“ã¨ã§ä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚');
        });
    });
});

    </script>
</body>

</html>